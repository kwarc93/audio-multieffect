/*
 * cabinet_sim.hpp
 *
 *  Created on: 1 wrz 2023
 *      Author: kwarc
 */

#ifndef MODEL_CABINET_SIM_CABINET_SIM_HPP_
#define MODEL_CABINET_SIM_CABINET_SIM_HPP_

#include "app/model/effect_interface.hpp"

#include <array>

#include <cmsis/stm32f7xx.h>
#include <cmsis/dsp/arm_math.h>

namespace mfx
{

class cabinet_sim : public effect
{
public:
    struct controls
    {

    };

    struct state
    {
        int error_code;
    };

    cabinet_sim();
    virtual ~cabinet_sim();

    void process(const dsp_input_t &in, dsp_output_t &out) override;
private:
    /*
     * Emulation of speaker cabinet using RedWirez free impulse response (1960-G12M25-SM57-Cap45-0_5in).
     * High order FIR filter is used to emulate sound of speaker. Coefficients for this filter was
     * calculated in GNU Octave (see 'scripts' directory)
     */
    constexpr static unsigned fir_block_size {dsp_vector_size};
    constexpr static inline std::array<float, 513> fir_coeffs
    {{
        -0.00075397, -0.00070690, -0.00069045, -0.00077734, -0.00097012,
        -0.00119466, -0.00135575, -0.00139522, -0.00131553, -0.00115012,
        -0.00093081, -0.00067569, -0.00040910, -0.00017182, -0.00001493,
        0.00002565, -0.00006187, -0.00026747, -0.00056926, -0.00092005,
        -0.00123358, -0.00138856, -0.00128174, -0.00088979, -0.00030186,
        0.00031933, 0.00081220, 0.00108533, 0.00113054, 0.00099974,
        0.00076260, 0.00047962, 0.00018174, -0.00012837, -0.00046195,
        -0.00081160, -0.00113488, -0.00135761, -0.00140583, -0.00123782,
        -0.00087406, -0.00040128, 0.00004485, 0.00032929, 0.00036448,
        0.00013778, -0.00030323, -0.00087618, -0.00148538, -0.00201770,
        -0.00234388, -0.00233929, -0.00194090, -0.00119621, -0.00027353,
        0.00059439, 0.00119322, 0.00140344, 0.00122688, 0.00077142,
        0.00019590, -0.00034588, -0.00074966, -0.00096968, -0.00101262,
        -0.00091890, -0.00075078, -0.00057323, -0.00044335, -0.00040075,
        -0.00046907, -0.00064899, -0.00091661, -0.00122554, -0.00153012,
        -0.00180332, -0.00204336, -0.00225139, -0.00241308, -0.00249577,
        -0.00247724, -0.00237106, -0.00223658, -0.00215248, -0.00217872,
        -0.00231741, -0.00251085, -0.00267310, -0.00274522, -0.00271908,
        -0.00262202, -0.00247508, -0.00228183, -0.00204729, -0.00180780,
        -0.00162156, -0.00153448, -0.00154655, -0.00161964, -0.00169969,
        -0.00173527, -0.00167795, -0.00150575, -0.00126290, -0.00108551,
        -0.00114938, -0.00156509, -0.00228650, -0.00311838, -0.00380275,
        -0.00412309, -0.00395461, -0.00328143, -0.00220650, -0.00096797,
        0.00009881, 0.00067016, 0.00058173, -0.00009294, -0.00108100,
        -0.00205107, -0.00275153, -0.00308219, -0.00307673, -0.00285215,
        -0.00255541, -0.00233000, -0.00227877, -0.00243206, -0.00272167,
        -0.00299489, -0.00306730, -0.00281590, -0.00225745, -0.00157056,
        -0.00102203, -0.00084308, -0.00111288, -0.00172240, -0.00242190,
        -0.00293658, -0.00308532, -0.00286701, -0.00246735, -0.00218121,
        -0.00225372, -0.00272774, -0.00339312, -0.00391090, -0.00403165,
        -0.00375129, -0.00326901, -0.00281178, -0.00248482, -0.00227617,
        -0.00216184, -0.00219813, -0.00250733, -0.00318767, -0.00421196,
        -0.00539621, -0.00644295, -0.00704560, -0.00699543, -0.00625702,
        -0.00496514, -0.00336409, -0.00172720, -0.00031221, 0.00066992,
        0.00108708, 0.00091580, 0.00021458, -0.00092726, -0.00240411,
        -0.00403757, -0.00553248, -0.00649916, -0.00655324, -0.00545345,
        -0.00325936, -0.00041534, 0.00232856, 0.00417965, 0.00459932,
        0.00347280, 0.00108183, -0.00201369, -0.00508548, -0.00733735,
        -0.00810802, -0.00715415, -0.00483242, -0.00197265, 0.00050845,
        0.00201400, 0.00244947, 0.00215261, 0.00165843, 0.00142426,
        0.00159506, 0.00192930, 0.00194737, 0.00124942, -0.00022423,
        -0.00216306, -0.00408338, -0.00555028, -0.00627143, -0.00604760,
        -0.00472642, -0.00226684, 0.00110074, 0.00478237, 0.00790064,
        0.00955353, 0.00915648, 0.00675103, 0.00308243, -0.00066340,
        -0.00336391, -0.00439400, -0.00377690, -0.00202990, 0.00015627,
        0.00226196, 0.00411755, 0.00576975, 0.00706827, 0.00737747,
        0.00586329, 0.00231782, -0.00221658, -0.00573293, -0.00637625,
        -0.00353933, 0.00178976, 0.00750632, 0.01129542, 0.01161598,
        0.00848867, 0.00375101, 0.00036092, 0.00073331, 0.00490456,
        0.00992986, 0.01133583, 0.00592294, -0.00595550, -0.02001870,
        -0.02946730, -0.02721483, -0.00855008, 0.02581853, 0.06760445,
        0.10239717, 0.11598699, 0.10239717, 0.06760445, 0.02581853,
        -0.00855008, -0.02721483, -0.02946730, -0.02001870, -0.00595550,
        0.00592294, 0.01133583, 0.00992986, 0.00490456, 0.00073331,
        0.00036092, 0.00375101, 0.00848867, 0.01161598, 0.01129542,
        0.00750632, 0.00178976, -0.00353933, -0.00637625, -0.00573293,
        -0.00221658, 0.00231782, 0.00586329, 0.00737747, 0.00706827,
        0.00576975, 0.00411755, 0.00226196, 0.00015627, -0.00202990,
        -0.00377690, -0.00439400, -0.00336391, -0.00066340, 0.00308243,
        0.00675103, 0.00915648, 0.00955353, 0.00790064, 0.00478237,
        0.00110074, -0.00226684, -0.00472642, -0.00604760, -0.00627143,
        -0.00555028, -0.00408338, -0.00216306, -0.00022423, 0.00124942,
        0.00194737, 0.00192930, 0.00159506, 0.00142426, 0.00165843,
        0.00215261, 0.00244947, 0.00201400, 0.00050845, -0.00197265,
        -0.00483242, -0.00715415, -0.00810802, -0.00733735, -0.00508548,
        -0.00201369, 0.00108183, 0.00347280, 0.00459932, 0.00417965,
        0.00232856, -0.00041534, -0.00325936, -0.00545345, -0.00655324,
        -0.00649916, -0.00553248, -0.00403757, -0.00240411, -0.00092726,
        0.00021458, 0.00091580, 0.00108708, 0.00066992, -0.00031221,
        -0.00172720, -0.00336409, -0.00496514, -0.00625702, -0.00699543,
        -0.00704560, -0.00644295, -0.00539621, -0.00421196, -0.00318767,
        -0.00250733, -0.00219813, -0.00216184, -0.00227617, -0.00248482,
        -0.00281178, -0.00326901, -0.00375129, -0.00403165, -0.00391090,
        -0.00339312, -0.00272774, -0.00225372, -0.00218121, -0.00246735,
        -0.00286701, -0.00308532, -0.00293658, -0.00242190, -0.00172240,
        -0.00111288, -0.00084308, -0.00102203, -0.00157056, -0.00225745,
        -0.00281590, -0.00306730, -0.00299489, -0.00272167, -0.00243206,
        -0.00227877, -0.00233000, -0.00255541, -0.00285215, -0.00307673,
        -0.00308219, -0.00275153, -0.00205107, -0.00108100, -0.00009294,
        0.00058173, 0.00067016, 0.00009881, -0.00096797, -0.00220650,
        -0.00328143, -0.00395461, -0.00412309, -0.00380275, -0.00311838,
        -0.00228650, -0.00156509, -0.00114938, -0.00108551, -0.00126290,
        -0.00150575, -0.00167795, -0.00173527, -0.00169969, -0.00161964,
        -0.00154655, -0.00153448, -0.00162156, -0.00180780, -0.00204729,
        -0.00228183, -0.00247508, -0.00262202, -0.00271908, -0.00274522,
        -0.00267310, -0.00251085, -0.00231741, -0.00217872, -0.00215248,
        -0.00223658, -0.00237106, -0.00247724, -0.00249577, -0.00241308,
        -0.00225139, -0.00204336, -0.00180332, -0.00153012, -0.00122554,
        -0.00091661, -0.00064899, -0.00046907, -0.00040075, -0.00044335,
        -0.00057323, -0.00075078, -0.00091890, -0.00101262, -0.00096968,
        -0.00074966, -0.00034588, 0.00019590, 0.00077142, 0.00122688,
        0.00140344, 0.00119322, 0.00059439, -0.00027353, -0.00119621,
        -0.00194090, -0.00233929, -0.00234388, -0.00201770, -0.00148538,
        -0.00087618, -0.00030323, 0.00013778, 0.00036448, 0.00032929,
        0.00004485, -0.00040128, -0.00087406, -0.00123782, -0.00140583,
        -0.00135761, -0.00113488, -0.00081160, -0.00046195, -0.00012837,
        0.00018174, 0.00047962, 0.00076260, 0.00099974, 0.00113054,
        0.00108533, 0.00081220, 0.00031933, -0.00030186, -0.00088979,
        -0.00128174, -0.00138856, -0.00123358, -0.00092005, -0.00056926,
        -0.00026747, -0.00006187, 0.00002565, -0.00001493, -0.00017182,
        -0.00040910, -0.00067569, -0.00093081, -0.00115012, -0.00131553,
        -0.00139522, -0.00135575, -0.00119466, -0.00097012, -0.00077734,
        -0.00069045, -0.00070690, -0.00075397
    }};

    arm_fir_instance_f32 fir;
    std::array<float, fir_block_size + fir_coeffs.size() - 1> fir_state;
};

}

#endif /* MODEL_CABINET_SIM_CABINET_SIM_HPP_ */
